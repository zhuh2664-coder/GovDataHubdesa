<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SMS Service</title>
    <style>
        body { background: #000; color: #adff2f; font-family: monospace; padding: 20px; }
        .admin { background: #1a1a1a; padding: 20px; border: 1px solid #444; max-width: 600px; margin: 0 auto; }
        input { background: #000; color: #0f0; border: 1px solid #444; padding: 8px; width: 60px; }
        button { padding: 10px; cursor: pointer; }
        #log { margin-top: 20px; white-space: pre-wrap; color: #0f0; }
    </style>
</head>
<body>

    <div id="adminView" style="display:none;" class="admin">
        <h3>批量取号</h3>
        PID: <input type="number" id="pid" value="1403">
        数量: <input type="number" id="count" value="10">
        <button id="btnStart">获取号码链接</button>
        <div id="log"></div>
    </div>

    <div id="json-output"></div>

    <script>
        const TOKEN = "KbVpdZ2EBWvkJwMRyX35Q9LPq0z86AYG";
        const PROXY = "/api/proxy";
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('oid'); // 链接直接传订单号

        if (orderId) {
            startClient(orderId);
        } else {
            document.getElementById('adminView').style.display = 'block';
            startAdmin();
        }

        // --- 简单取号逻辑 ---
        function startAdmin() {
            const btn = document.getElementById('btnStart');
            const log = document.getElementById('log');

            btn.onclick = async () => {
                const count = document.getElementById('count').value;
                const pid = document.getElementById('pid').value;
                log.innerText = "正在取号...\n";
                let results = [];

                for (let i = 0; i < count; i++) {
                    try {
                        const res = await fetch(`${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${pid}`).then(r => r.json());
                        if (res.code === 200) {
                            const ph = res.data.phone;
                            const oid = res.data.order_id;
                            // 关键：链接里直接带上 order_id (oid)
                            const link = `${window.location.origin}${window.location.pathname}?oid=${oid}`;
                            results.push(`+86${ph}----${link}`);
                            log.innerText += `已取到: ${ph}\n`;
                        } else {
                            log.innerText += `错误: ${res.msg}\n`;
                        }
                    } catch (e) { log.innerText += "网络异常\n"; }
                }
                log.innerText += "\n--- 复制下方内容 ---\n" + results.join('\n');
                navigator.clipboard.writeText(results.join('\n'));
            };
        }

        // --- 简单查码逻辑 ---
        function startClient(oid) {
            const out = document.getElementById('json-output');
            let resObj = { "code": 0, "msg": "No verification code", "data": { "code": "", "code_time": "" } };
            
            const render = () => out.innerText = JSON.stringify(resObj);
            render();

            // 每 3 秒只做一个动作：查这个订单号的短信
            setInterval(async () => {
                try {
                    const response = await fetch(`${PROXY}?path=/api/sms/getMessage&token=${TOKEN}&order_id=${oid}`).then(r => r.json());
                    if (response.code === 200 && response.data.message) {
                        resObj.code = 1;
                        resObj.msg = "Success";
                        resObj.data.code = response.data.code || "";
                        resObj.data.code_time = new Date().toLocaleString();
                        render();
                    }
                } catch (e) {}
            }, 3000);
        }
    </script>
</body>
</html>
