<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>API Data Provider</title>
    <style>
        body { 
            background-color: #1e1e1e; color: #adff2f; 
            font-family: monospace; padding: 20px; word-break: break-all; 
        }
    </style>
</head>
<body>
    <div id="json-output">加载中...</div>

    <script>
        const TOKEN = "KbVpdZ2EBWvkJwMRyX35Q9LPq0z86AYG";
        const PROXY = "/api/proxy";
        const params = new URLSearchParams(window.location.search);
        const phone = params.get('phone');
        const pid = params.get('pid') || "1403";

        // 默认返回模板（未收到验证码时）
        let responseData = {
            "code": 0,
            "msg": "No verification code",
            "data": {
                "code": "",
                "code_time": "",
                "expired_date": "2026-03-09 00:00:00"
            }
        };

        const render = () => {
            document.getElementById('json-output').innerText = JSON.stringify(responseData);
        };

        async function startApiFlow() {
            if (!phone) {
                responseData.msg = "Missing phone parameter";
                render();
                return;
            }

            // 1. 激活控制权并获取订单
            try {
                const res = await fetch(`${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${pid}&phone=${phone}`).then(r => r.json());
                if (res.code === 200) {
                    const oid = res.data.order_id;
                    pollSms(oid);
                } else {
                    responseData.msg = "Number expired or released";
                    render();
                }
            } catch (e) {
                responseData.msg = "Proxy Error";
                render();
            }
        }

        function pollSms(oid) {
            const timer = setInterval(async () => {
                try {
                    const res = await fetch(`${PROXY}?path=/api/sms/getMessage&token=${TOKEN}&order_id=${oid}`).then(r => r.json());
                    
                    if (res.code === 200 && res.data.message) {
                        // 2. 成功获取，修改 JSON 内容
                        responseData.code = 1; // 1 表示成功拿到
                        responseData.msg = "Success";
                        responseData.data.code = res.data.code || ""; // 提取纯数字验证码
                        responseData.data.code_time = new Date().toLocaleString();
                        
                        render();
                        clearInterval(timer);
                    } else if (res.code === 5 || res.code === 6) {
                        // 订单失效尝试自动重连一次
                        clearInterval(timer);
                        startApiFlow();
                    } else {
                        // 持续输出“未收到”的初始 JSON
                        render();
                    }
                } catch (e) {}
            }, 3000);
        }

        // 如果是管理端（没带phone参数），则显示原来的批量取号界面
        if (!phone) {
            // 这里保留你之前的批量管理后台 HTML 代码，或者直接跳转
            window.location.href = "about:blank"; // 或者显示一个简单的提示
            document.body.innerHTML = "<h2>管理后台请使用主域名访问</h2>";
        } else {
            startApiFlow();
        }
    </script>
</body>
</html>
