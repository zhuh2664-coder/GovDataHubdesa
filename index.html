<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接码管理系统-批量版</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; }
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 550px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; }
        #btnBatch { background: var(--primary); width: 100%; height: 50px; font-size: 16px; margin-bottom: 15px; }
        #btnCopyAll { background: var(--success); display: none; margin-bottom: 10px; }
        .result-list { background: #333; color: #adff2f; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        /* 客户端样式 */
        .client-view { text-align: center; display: none; }
        .sms-code { font-size: 48px; color: var(--primary); font-weight: bold; margin: 30px 0; letter-spacing: 5px; }
        .status-msg { color: #666; font-size: 14px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="title" style="text-align:center; margin-top:0;">接码助手后台</h2>

        <div id="adminPanel">
            <div class="input-row">
                <input type="number" id="pid" value="1403" placeholder="项目PID">
                <input type="number" id="count" value="1" min="1" max="20" placeholder="取号数量">
            </div>
            <button id="btnBatch">开始批量取号 (生成永久链接)</button>
            
            <div id="resultArea" style="display:none; margin-top:15px;">
                <button id="btnCopyAll">一键复制全部 10 行</button>
                <div id="batchList" class="result-list"></div>
                <p style="font-size: 11px; color: #999; margin-top: 5px;">* 格式已自动适配：+86手机号----永久链接</p>
            </div>
        </div>

        <div id="clientPanel" class="client-view">
            <div class="status-msg" id="status">⏳ 正在同步数据...</div>
            <div class="sms-code" id="smsCode">查收中</div>
            <div id="fullMsg" style="font-size: 13px; color: #999; background:#f8f9fa; padding:10px; border-radius:6px;">等待验证码内容...</div>
        </div>
    </div>

    <script>
        const TOKEN = "KbVpdZ2EBWvkJwMRyX35Q9LPq0z86AYG";
        const PROXY = "/api/proxy";
        const params = new URLSearchParams(window.location.search);
        const phoneParam = params.get('phone');
        const pidParam = params.get('pid');

        if (phoneParam) {
            runClient(phoneParam, pidParam);
        } else {
            runAdmin();
        }

        // --- 管理员逻辑：循环取号 ---
        function runAdmin() {
            const btn = document.getElementById('btnBatch');
            const batchList = document.getElementById('batchList');
            const copyBtn = document.getElementById('btnCopyAll');

            btn.onclick = async () => {
                const count = parseInt(document.getElementById('count').value) || 1;
                const pid = document.getElementById('pid').value;
                btn.disabled = true;
                btn.innerText = `正在批量取号 (0/${count})...`;
                batchList.innerText = ""; // 清空旧数据
                
                let results = [];

                for (let i = 0; i < count; i++) {
                    btn.innerText = `正在批量取号 (${i + 1}/${count})...`;
                    try {
                        const res = await fetch(`${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${pid}`).then(r => r.json());
                        if (res.code === 200) {
                            const phone = res.data.phone;
                            const link = `${window.location.origin}${window.location.pathname}?phone=${phone}&pid=${pid}`;
                            const line = `+86${phone}----${link}`;
                            results.push(line);
                            batchList.innerText = results.join('\n'); // 实时显示
                        } else {
                            results.push(`第 ${i+1} 个失败: ${res.msg}`);
                        }
                    } catch (e) { results.push(`网络错误`); }
                    // 稍微停顿一下，防止请求过快被接口封禁
                    await new Promise(r => setTimeout(r, 500));
                }

                document.getElementById('resultArea').style.display = 'block';
                copyBtn.style.display = 'block';
                copyBtn.innerText = `一键复制全部 ${results.length} 行`;
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(results.join('\n'));
                    alert("全部内容已复制！");
                };
                
                btn.disabled = false;
                btn.innerText = "开始批量取号 (生成永久链接)";
            };
        }

        // --- 客户端逻辑：3秒极速听码 ---
        async function runClient(phone, pid) {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('clientPanel').style.display = 'block';
            document.getElementById('title').innerText = "验证码查收";
            
            let currentOid = "";
            const statusEl = document.getElementById('status');

            const getOid = async () => {
                statusEl.innerText = "正在激活号码控制权...";
                try {
                    const res = await fetch(`${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${pid}&phone=${phone}`).then(r => r.json());
                    return res.code === 200 ? res.data.order_id : null;
                } catch (e) { return null; }
            };

            currentOid = await getOid();
            if (!currentOid) { statusEl.innerText = "❌ 该号码无法激活或已释放"; return; }

            statusEl.innerText = "⏳ 正在监听短信 (每3秒更新)...";
            const timer = setInterval(async () => {
                try {
                    const res = await fetch(`${PROXY}?path=/api/sms/getMessage&token=${TOKEN}&order_id=${currentOid}`).then(r => r.json());
                    if (res.code === 200 && res.data.message) {
                        document.getElementById('smsCode').innerText = res.data.code || "已接收";
                        document.getElementById('fullMsg').innerText = res.data.message;
                        statusEl.innerText = "✅ 验证码同步成功";
                        clearInterval(timer);
                    } else if (res.code === 5 || res.code === 6) {
                        currentOid = await getOid(); // 自动续期
                    }
                } catch (e) {}
            }, 3000);
        }
    </script>
</body>
</html>
