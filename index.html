<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>API Connector</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; }
    </style>
</head>
<body>
    <div id="out">{"code":0,"msg":"Initializing..."}</div>

    <script>
        const TOKEN = "KbVpdZ2EBWvkJwMRyX35Q9LPq0z86AYG";
        const PROXY = "/api/proxy";
        const params = new URLSearchParams(window.location.search);
        const pid = params.get('pid') || "1403";
        const targetPhone = params.get('phone'); // 如果带了phone说明是查老号，不带说明是取新号

        let resObj = {
            "code": 0,
            "msg": "No verification code",
            "data": { "code": "", "code_time": "", "expired_date": "2026-03-09 00:00:00" }
        };

        const render = () => document.getElementById('out').innerText = JSON.stringify(resObj);

        async function init() {
            try {
                // 1. 获取/激活号码 (遵循文档：不传phone即取新号，传phone即回捞)
                let url = `${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${pid}`;
                if (targetPhone) url += `&phone=${targetPhone}`;

                const res = await fetch(url).then(r => r.json());

                if (res.code === 200) {
                    const oid = res.data.order_id;
                    const ph = res.data.phone;
                    
                    // 如果是取新号，可以在msg里返回一下手机号方便你记录
                    if (!targetPhone) resObj.msg = "New Number: " + ph;
                    render();

                    // 2. 开启自动听码轮询
                    const timer = setInterval(async () => {
                        try {
                            const msgRes = await fetch(`${PROXY}?path=/api/sms/getMessage&token=${TOKEN}&order_id=${oid}`).then(r => r.json());
                            if (msgRes.code === 200 && msgRes.data.message) {
                                resObj.code = 1;
                                resObj.msg = "Success";
                                resObj.data.code = msgRes.data.code || "";
                                resObj.data.code_time = new Date().toLocaleString();
                                render();
                                clearInterval(timer);
                            }
                        } catch (e) {}
                    }, 3000);
                } else {
                    resObj.msg = "API Error: " + res.msg;
                    render();
                }
            } catch (e) {
                resObj.msg = "Network Error";
                render();
            }
        }

        init();
    </script>
</body>
</html>
