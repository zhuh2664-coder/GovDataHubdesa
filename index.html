<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>验证码查收</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        .sms-code { font-size: 45px; color: #007bff; font-weight: bold; margin: 20px 0; letter-spacing: 2px; }
        .btn-main { width: 100%; padding: 14px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .copy-box { background: #eee; padding: 10px; font-family: monospace; font-size: 12px; margin-top: 10px; border-radius: 4px; cursor: pointer; word-break: break-all; }
        #log { font-size: 12px; color: #999; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="title">接码助手</h2>

        <div id="adminPanel">
            <input type="number" id="pid" value="1403" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;" placeholder="项目PID">
            <button class="btn-main" id="btnRun">一键取号并生成永久链接</button>
            <div id="resultArea" style="display:none; margin-top:15px; text-align:left;">
                <label style="font-size:12px; color:#666;">自动生成的永久格式：</label>
                <div id="copyContent" class="copy-box"></div>
            </div>
        </div>

        <div id="clientPanel" style="display:none;">
            <div id="status">正在同步数据...</div>
            <div id="smsCode" class="sms-code">--- ---</div>
            <div id="fullMsg" style="font-size: 13px; color: #999;"></div>
        </div>

        <div id="log">系统就绪</div>
    </div>

    <script>
        const TOKEN = "KbVpdZ2EBWvkJwMRyX35Q9LPq0z86AYG";
        const PROXY = "/api/proxy";
        const urlParams = new URLSearchParams(window.location.search);
        const phoneParam = urlParams.get('phone'); // 核心：按手机号查询

        if (phoneParam) {
            startClientFlow(phoneParam);
        } else {
            initAdminFlow();
        }

        // --- 1. 管理端逻辑 ---
        function initAdminFlow() {
            document.getElementById('btnRun').onclick = async function() {
                const pid = document.getElementById('pid').value;
                this.disabled = true;
                this.innerText = "获取中...";
                
                try {
                    const res = await fetch(`${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${pid}`).then(r => r.json());
                    if (res.code === 200) {
                        const phone = res.data.phone;
                        // 核心：生成的链接不再带 order_id，而是带 phone
                        const permanentUrl = window.location.origin + window.location.pathname + "?phone=" + phone + "&pid=" + pid;
                        const finalFormat = `+86${phone}----${permanentUrl}`;
                        
                        document.getElementById('copyContent').innerText = finalFormat;
                        document.getElementById('resultArea').style.display = 'block';
                        navigator.clipboard.writeText(finalFormat);
                        this.innerText = "生成成功并已复制";
                    } else { alert("取号失败: " + res.msg); }
                } catch (e) { alert("网络错误"); }
                this.disabled = false;
            };
        }

        // --- 2. 客户展示逻辑 (自动续费订单) ---
        async function startClientFlow(phone) {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('clientPanel').style.display = 'block';
            document.getElementById('title').innerText = "验证码查收";
            const pid = urlParams.get('pid') || "1403";
            let currentOid = "";

            // 第一步：自动去换一个新的订单号
            const getNewOrder = async () => {
                try {
                    document.getElementById('status').innerText = "正在为您激活号码控制权...";
                    const res = await fetch(`${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${pid}&phone=${phone}`).then(r => r.json());
                    if (res.code === 200) {
                        return res.data.order_id;
                    }
                    return null;
                } catch (e) { return null; }
            };

            currentOid = await getNewOrder();
            if (!currentOid) {
                document.getElementById('status').innerText = "❌ 该号码已过期或被释放";
                return;
            }

            // 第二步：开始轮询短信内容
            setInterval(async () => {
                try {
                    const res = await fetch(`${PROXY}?path=/api/sms/getMessage&token=${TOKEN}&order_id=${currentOid}`).then(r => r.json());
                    if (res.code === 200 && res.data.message) {
                        document.getElementById('smsCode').innerText = res.data.code || "已收到";
                        document.getElementById('fullMsg').innerText = res.data.message;
                        document.getElementById('status').innerText = "✅ 验证码已同步";
                    } else if (res.code === 5 || res.code === 6) { // 订单失效时，自动再申请一次
                        currentOid = await getNewOrder();
                    }
                } catch (e) {}
            }, 8000);
        }
    </script>
</body>
</html>
