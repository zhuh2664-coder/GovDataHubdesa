<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>API Service</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; }
        .btn-box { background: #1a1a1a; padding: 20px; border: 1px solid #444; margin-bottom: 20px; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; }
        #json-output { font-size: 18px; color: #adff2f; margin-top: 20px; word-break: break-all; }
    </style>
</head>
<body>

    <div class="btn-box">
        <h3>华住会自动接码</h3>
        <button id="getBtn">点击获取新号码并听码</button>
    </div>

    <div id="json-output">{"code":0,"msg":"Ready to get number","data":{"code":"","code_time":"","expired_date":"2026-03-09 00:00:00"}}</div>

    <script>
        const TOKEN = "KbVpdZ2EBWvkJwMRyX35Q9LPq0z86AYG";
        const PROXY = "/api/proxy";
        const PID = "1403";

        const output = document.getElementById('json-output');
        const btn = document.getElementById('getBtn');

        let resObj = {
            "code": 0,
            "msg": "No verification code",
            "data": { "code": "", "code_time": "", "expired_date":"2026-03-09 00:00:00" }
        };

        const render = () => { output.innerText = JSON.stringify(resObj); };

        btn.onclick = async () => {
            btn.disabled = true;
            resObj.msg = "Fetching number...";
            render();

            try {
                // 1. 获取号码
                const res = await fetch(`${PROXY}?path=/api/sms/getPhone&token=${TOKEN}&pid=${PID}`).then(r => r.json());
                
                if (res.code === 200) {
                    const ph = res.data.phone;
                    const oid = res.data.order_id;
                    
                    // 拿到号了，更新 JSON
                    resObj.msg = "Number: " + ph + " | Waiting for SMS...";
                    render();

                    // 2. 开启轮询查短信
                    const timer = setInterval(async () => {
                        const msgRes = await fetch(`${PROXY}?path=/api/sms/getMessage&token=${TOKEN}&order_id=${oid}`).then(r => r.json());
                        
                        if (msgRes.code === 200 && msgRes.data.message) {
                            resObj.code = 1;
                            resObj.msg = "Success";
                            resObj.data.code = msgRes.data.code || "";
                            resObj.data.code_time = new Date().toLocaleString();
                            render();
                            clearInterval(timer);
                            btn.disabled = false;
                        } else if (msgRes.code === 5 || msgRes.code === 6) {
                            // 订单异常或超时
                            resObj.msg = "Order expired";
                            render();
                            clearInterval(timer);
                            btn.disabled = false;
                        }
                    }, 3000);

                } else {
                    resObj.msg = "Error: " + res.msg;
                    render();
                    btn.disabled = false;
                }
            } catch (e) {
                resObj.msg = "Network Error";
                render();
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
